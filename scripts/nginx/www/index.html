<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TutelarAuth</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        var params = new URLSearchParams(window.location.search);

        function errorNotification(message) {
            var error = $('#error');
            error.text(message);
            error.fadeIn(200, function () {
                error.fadeOut(3500);
            });
        }
        function infoNotification(message) {
            var info = $('#info');
            info.text(message);
            info.fadeIn(200, function () {
                info.fadeOut(3500);
            });
        }

        function login(token) {
            try {
                var base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
                localStorage.userid = JSON.parse(window.atob(base64)).id;
            } catch (e) {
                errorNotification('WRONG TOKEN');
            } finally {
                window.location.replace('https://lvh.me:9443/index.html');
            }
        }

        function sendForm(url) {
            var extraData;
            try {
                extraData = JSON.parse($('#extra').val());
            } catch (e) {
            }

            var formData = {
                username: $('#username').val(),
                password: $('#password').val(),
                data: extraData
            };
            $.ajax({
                type: 'POST',
                url: url,
                data: JSON.stringify(formData),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data) {
                    login(data.token);
                }
            }).fail(function (data) {
                try {
                    errorNotification(data.responseJSON.error);
                } catch (e) {
                    errorNotification('Unknown error');
                }
            });
        }

        function sendEmailRegisterRequest() {
            var formData = {
                email: $('#username').val()
            };
            $.ajax({
                type: 'POST',
                url: "/email/send-register",
                data: JSON.stringify(formData),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    infoNotification('Registration email sent')
                }
            }).fail(function (data) {
                try {
                    errorNotification(data.responseJSON.error);
                } catch (e) {
                    errorNotification('Unknown error');
                }
            });
        }

        function getRegistrationToken() {
            return params.get('registerToken')
        }

        function registerWithEmail() {
            var extraData;
            try {
                extraData = JSON.parse($('#extra').val());
            } catch (e) {
            }

            var formData = {
                token: getRegistrationToken(),
                password: $('#password').val(),
                data: extraData
            };
            $.ajax({
                type: 'POST',
                url: "/email/register",
                data: JSON.stringify(formData),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (data) {
                    login(data.token);
                }
            }).fail(function (data) {
                try {
                    errorNotification(data.responseJSON.error);
                } catch (e) {
                    errorNotification('Unknown error');
                }
            });
        }

        function initButtons() {
            $('#logout').click(function () {
                localStorage.removeItem('userid');
                window.location.replace('https://lvh.me:9443/index.html');
            });

            $('#register_user_pass').click(function () {
                sendForm('/basic/register')
            });
            $('#login_user_pass').click(function () {
                sendForm('/basic/login')
            });
            $('#login_ldap').click(function () {
                sendForm('/ldap/login')
            });
            $('#login_github').click(function () {
                window.location.replace('/github/login');
            });
            $('#login_facebook').click(function () {
                window.location.replace('/facebook/login');
            });
            $('#login_google').click(function () {
                window.location.replace('/google/login');
            });

            $('#send_register_email').click(sendEmailRegisterRequest);
            $('#register_email').click(registerWithEmail);
            $('#login_email').click(function () {
                sendForm('/email/login')
            });
        }

        function handleCallbackLogin() {
            if (params.has('error')) {
                errorNotification(params.get('error'));
            }
            if (params.has('token')) {
                login(params.get('token'));
            }
            if (params.has('registerToken')) {
                var base64 = params.get('registerToken').split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
                var email = JSON.parse(window.atob(base64)).email;
                var username = $('#username');
                username.prop('disabled', true);
                username.val(email);
                $('#send_register_email').prop('disabled', true);
                $('#register_email').prop('disabled', false);
            }
        }

        $(window).on('load', function () {
            handleCallbackLogin();
            initButtons();

            if (!!localStorage.userid) {
                $('#userid').text(localStorage.userid);
                $('#authenticated').show();
            } else {
                $('#login').show();
            }

        });
    </script>
    <style>
        label {
            width: 45px;
            display: inline-block;
        }

        div {
            margin-bottom: 5px;
        }

        #error {
            border: 1px solid red;
            background: lightpink;
            padding: 5px;
            text-align: center;
        }

        #info {
            border: 1px solid blue;
            background: lightblue;
            padding: 5px;
            text-align: center;
        }

        .user_pass {
            background-color: lightblue;
        }

        .ldap {
            background-color: lightyellow;
        }

        .email {
            background-color: lightgreen;
        }

        .oauth {
            background-color: lightsalmon;
        }
    </style>
</head>
<body>
<div id="login" style="display: none">
    <p>
    <div>
        <label>User:</label><input type="text" id="username"/>
    </div>
    <div>
        <label>Pass:</label><input type="password" id="password"/>
    </div>
    <div>
        <label>Extra Json:</label><textarea id="extra"></textarea>
    </div>
    <div>
        <button id="register_user_pass" class="user_pass">Register</button>
        <button id="login_user_pass" class="user_pass">Login</button>
        <button id="login_ldap" class="ldap">Login with LDAP</button>
        <button id="send_register_email" class="email">Send register email</button>
        <button id="register_email" class="email" disabled>Register with email</button>
        <button id="login_email" class="email">Login with email</button>
    </div>
    </p>
    <p>
        <button id="login_github" class="oauth">Login with GitHub</button>
        <button id="login_facebook" class="oauth">Login with Facebook</button>
        <button id="login_google" class="oauth">Login with Google</button>
    </p>
</div>

<div id="authenticated" style="display: none">
    Hello <b><span id="userid"></span></b>!<br/>
    <button id="logout">Logout</button>
</div>

<div id="error" style="display: none"></div>
<div id="info" style="display: none"></div>
</body>
</html>